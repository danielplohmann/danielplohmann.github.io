---
layout:             post
title:              "Quick analysis write-up on the "link" between Lazarus and WannaCry"
author:             Daniel Plohmann
date:               2017-05-16 01:00:00 +0100
last_modified_at:   2017-05-16 01:00:00 +0100
categories:         blog
tags:               [bytetlas, analysis, lazarus, wannacry]
---

Here is a short post on what I found out about the "link" between Lazarus and WannaCry.
To me, the function referenced looks a lot like only a generator for a TLS 1.0 client hello.

On 2017-05-15 19:02 [Neel Mehta][twitter neel] tweeted the following:

{% capture asset_link %}{% link /assets/20170516/tweet.png %}{% endcapture %}
[![screenshot]({{ asset_link | absolute_url }} "Neel Mehta tweet, linking the samples of WannaCry and Lazarus / Contopee")]({{ asset_link | absolute_url }})

If we have a closer look at `0x402560` in the [February WannaCry sample][february wannacry] (the function referenced and [compared][blog securelist] by some [others][blog comae]), we see the following:

{% capture asset_link %}{% link /assets/20170516/0x402560.png %}{% endcapture %}
[![screenshot]({{ asset_link | absolute_url }} "One of the two functions of interest")]({{ asset_link | absolute_url }})

For my point, of special interest is the buffer highlighted:

{% capture asset_link %}{% link /assets/20170516/cipher_ids.png %}{% endcapture %}
[![screenshot]({{ asset_link | absolute_url }} "An array containing SSL ciphersuite identifiers, as found in the binary.")]({{ asset_link | absolute_url }})

Searching for some of these constants, we can quickly infer that they likely infer to OpenSSL ciphersuites, as listed for example [here][testssl map].

While there are [TLS fingerprinting projects][tls fingerprints], I did not find matches for the embedded selection.

Now, if we run this function in a debugger like Olly:

{% capture asset_link %}{% link /assets/20170516/olly_dump.png %}{% endcapture %}
[![screenshot]({{ asset_link | absolute_url }} "Executing function 0x402560 and inspecting the output.")]({{ asset_link | absolute_url }})

You will see that it generates a buffer like shown in the lower left corner (dump window).

Here is a couple more of these, annotated:

{% capture asset_link %}{% link /assets/20170516/data_generated.png %}{% endcapture %}
[![screenshot]({{ asset_link | absolute_url }} "A couple more outputs, annotated with the TLS Client Hello structure.")]({{ asset_link | absolute_url }})

So the structure pretty much matches what you would expect from a [zero-len session-id TLS Client Hello][zerolen client hello].

Some more indicators for this claim that we look at Client Hellos is the usage in a function a bit up in the call chain:

{% capture asset_link %}{% link /assets/20170516/send_to_tor_ports.png %}{% endcapture %}
[![screenshot]({{ asset_link | absolute_url }} "Up the call stack, looking in which context the function / buffer is used.")]({{ asset_link | absolute_url }})

Here our buffer generated by `0x402560` is send to localhost listening on typical TOR ports.

Maybe some part of the TOR communication capability (or adapter) was directly embedded in this earlier version of WannaCry?

#### Assessment:

While I agree that the compiled functions from both samples ([A: WannaCry][vt wannacry], [B: Lazarus][vt lazarus]) originate very likely from the same source code and that they were compiled with similar tooling (there are some more indicators for this in how the generated code look likes, e.g. padding, thunks, ...), the exclusivity of the code defines the strength of the link.

This function provides a rather generic network-based functionality (yet in a strongly specific way), so I would not be surprised if eventually the respective source code appears as being publicly accessible in some corner of the wild and open Internet. 
In that case we could be looking at a super weird coincidence.

Hashes:
 * `3e6de9e2baacf930949647c399818e7a2caea2626df6a468407854aaa515eed9` - WannaCry, February 2017
 * `766d7d591b9ec1204518723a1e5940fd6ac777f606ed64e731fd91b0b4c3d9fc` - Contopee


*[link to original post on blogspot][blogspot post].*

[vt lazarus]: https://www.virustotal.com/de/file/766d7d591b9ec1204518723a1e5940fd6ac777f606ed64e731fd91b0b4c3d9fc/analysis/
[vt wannacry]: https://www.virustotal.com/de/file/3e6de9e2baacf930949647c399818e7a2caea2626df6a468407854aaa515eed9/analysis/
[zerolen client hello]: http://www.cisco.com/c/en/us/support/docs/security-vpn/secure-socket-layer-ssl/116181-technote-product-00.html
[tls fingerprints]: https://github.com/LeeBrotherston/tls-fingerprinting
[testssl map]: https://testssl.sh/openssl-rfc.mapping.html
[blog comae]: https://blog.comae.io/wannacry-links-to-lazarus-group-dcea72c99d2d
[blog securelist]: https://securelist.com/blog/research/78431/wannacry-and-lazarus-group-the-missing-link/
[february wannacry]: https://virustotal.com/en/file/3e6de9e2baacf930949647c399818e7a2caea2626df6a468407854aaa515eed9/analysis/
[twitter neel]: https://twitter.com/neelmehta

[blogspot post]: http://byte-atlas.blogspot.com/2017/05/wannacry-linked-function.html
